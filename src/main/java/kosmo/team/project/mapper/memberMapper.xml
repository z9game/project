<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kosmo.team.project.dao.MemberDAO">

	<insert id="insertMember" parameterType="kosmo.team.project.dto.MemberDTO">
		insert into member(
					m_no
					,name
					,mid
					,password
					,nickname
					,email
					,birthdate
					,phone
					,gender
					,sido_id
					,sigungu_id
					,detail_address
				)
		values(
			(select nvl(max(m_no),0)+1 from member)
			,#{name}
			,#{mid}
			,#{password}
			,#{nickname}
			,#{email}
			,to_date(#{birthday},'YYYY-MM-DD')
			,#{phone}
			,#{gender}
			,#{sido_id}
			,#{sigungu_id}
			,#{detail_address}
		)
	</insert>
	
	
	
	<insert id="insertDetail" parameterType="kosmo.team.project.dto.MemberDTO">
		insert into member_detail(
			member
		)
		values(
			(select max(m_no) from member)
		)
		
	</insert>
	
	<insert id="insertRecoed" parameterType="kosmo.team.project.dto.MemberDTO">
		insert into player_record(
			player
		)
		values(
			(select max(m_no) from member)
		)
		
	</insert>
	
	
	<select id="getmid" parameterType="kosmo.team.project.dto.MemberDTO" resultType="int">
		select count(*)
		from
			member
		where
			mid = #{mid}
	</select>
	
	<select id="updateMemForm" parameterType="kosmo.team.project.dto.MemberDTO" resultType="kosmo.team.project.dto.MemberDTO">
		select
		    m.name
		    ,m.mid
		    ,m.password
		    ,m.nickname
		    ,m.email
		    ,m.phone
		    ,s.name AS "sido"
    		,si.name AS "sigungu"
		    ,m.detail_address
		from
		     member m left join sido s ON m.sido_id = s.sido_id
             		  LEFT JOIN sigungu si ON m.sigungu_id = si.sigungu_id
		where
			mid = #{mid}
	</select>
	
	<update id="updateMem" parameterType="kosmo.team.project.dto.MemberDTO">
		update
			member
		set
			password = #{password}
			,email = #{email}
			,phone = #{phone}
			,sido_id = #{sido_id}
			,sigungu_id = #{sigungu_id}
			,detail_address = #{detail_address}
			,nickname = #{nickname}
		where
			mid = #{mid}
	</update>
	
	
	<!-- 마이페이지에 있는 내정보 가져오기 -->
	<select id="getMyInfo" parameterType="int" resultType="kosmo.team.project.dto.MemberDTO">
		select
		    m.name
		    ,m.m_no    
		    ,t.team_name 
		    ,t.team_master   
		from
		    member m left join team_member tm on m.m_no = tm.team_member  
		             left join team t on t.team_no = tm.team_no 
		where
			m.m_no = #{m_no}
	</select>
	
	<!-- 마이페이지에 있는 내기록 가져오기 -->
	<select id="getMyStat" parameterType="String" resultType="kosmo.team.project.dto.MemberDTO">
		select
		    r.games_played
		    ,r.wins
		    ,r.draws
		    ,r.losses
		    ,r.goals_for
		    ,r.goals_assist
		from 
		    member m left join player_record r on m.m_no = r.player
		where
		    m.mid = #{mid}
	</select>
	
	<!-- 예약한 경기장 가져오기 -->
	<select id="getBookedStadium" parameterType="int" resultType="kosmo.team.project.dto.bookingDTO">
		select
		    s.stadium_name
		    ,to_char(b.booking_date, 'YYYY-MM-DD') as "booking_date"
		    ,t.time_range
		from
		    booking b left join stadium s on b.stadium_no = s.stadium_no
		              left join time_table t on b.time_slot = t.time_no
		where
			b.m_no = #{m_no}
			and 
			(sysdate - booking_date) <![CDATA[ <0 ]]>
	</select>
	
	
	
	<!-- 팀 생성 -->
	<insert id="registTeam" parameterType="kosmo.team.project.dto.TeamDTO">
		insert into team(
			team_no
			,team_name
			,team_master
		)
		values(
			(select nvl(max(team_no),0)+1 from team)
			,#{team_name}
			,#{team_master}
		)
	</insert>
	
	<!-- 팀 생성후 멤버에 생성자 넣기 -->
	<insert id="firstTeamMem" parameterType="kosmo.team.project.dto.TeamDTO">
		insert into team_member(
			team_no
			,team_member
		)
		values(
			(select team_no from team where team_master = #{team_master})
			,#{team_master}
		)
	</insert>
	
	<!-- 팀수락 대기자 있는가? -->
	<select id="getWaitingCnt" parameterType="int" resultType="int">
		select
		    count(*)
		from
		    waiting_teamReg
		where
		    team=(
		    select  
		        team_no 
		    from
		        team_member 
		    where 
		        team_member = #{m_no} 
		    )
	</select>
	
	<!-- 용병수락 대기자 있는가? -->
	<select id="getMercWaitingCnt" parameterType="int" resultType="int">
		select
		    count(*)
		from
		    waiting_teamReg
		where
		    team=(
		    select  
		        team_no 
		    from
		        team_member 
		    where 
		        team_member = #{m_no} 
		    )
	</select>
	
	
	<!-- 팀수락 대기자 명단 -->
	<select id="getWaitingList" parameterType="int" resultType="kosmo.team.project.dto.TeamDTO">
		select
			m.m_no
		    ,m.name 
		    ,to_number(to_char(sysdate, 'YYYY')) -
				to_number(to_char(m.birthdate, 'YYYY')) AS "age" 
		    ,s.name as "sido"
		from
		    member m left join sido s on m.sido_id = s.sido_id
		             left join waiting_teamReg wt on m.m_no = wt.name 
		where
		    wt.team = (
		        select  
		            team_no 
		        from
		            team_member 
		        where 
		            team_member = #{m_no}  
		    )
	</select>
	
	
	<!-- 수락하면 내팀으로 들어오고 대기 테이블에서 삭제된다. -->
	<insert id="regTeamMem" parameterType="kosmo.team.project.dto.TeamDTO">
		 insert into team_member
      <foreach collection="m_no_A" item="m_no"  open= " ( "  close = " ) "   separator=" union " >
         select  (select team from waiting_teamReg where name = #{m_no}),#{m_no} from dual 
      </foreach>
	</insert>
	
	<delete id="delWaitingList" parameterType="kosmo.team.project.dto.TeamDTO">
		delete 
		from
			waiting_teamReg
		where
			<foreach collection="m_no_A" item="m_no"  open= " ( "  close = " ) "   separator=" or " >
	        name=#{m_no}
	        </foreach>
	</delete>
	
	
	<!-- 내 팀정보를 가져온다 -->
	<select id="getTeamInfo" parameterType="int" resultType="kosmo.team.project.dto.TeamDTO">
		select
		    m.name 
		    ,m.m_no
		    ,to_number(to_char(sysdate, 'YYYY')) -
		        to_number(to_char(m.birthdate, 'YYYY')) AS "age" 
		    ,s.name as "sido"
		from
		     member m left join sido s on m.sido_id = s.sido_id
		              left join team_member tm on m.m_no = tm.team_member
		where
		    tm.team_no = (select team_no from team_member where team_member = #{team_no})     
		
	</select>
	
	
	
	
</mapper>